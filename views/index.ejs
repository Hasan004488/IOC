<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search - Threat Intelligence</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="search" role="tabpanel" aria-labelledby="search-tab">
                        <div class="hero-search d-flex align-items-center">
                            <div class="container text-center">
                                <header class="mb-5">
                                    <h1 class="display-4 fw-bold">Threat Intelligence Center</h1>
                                    <p class="lead text-muted">On-demand IOC Scanning and Monitoring.</p>
                                </header>

                                <div class="row justify-content-center">
                                    <div class="col-lg-8">
                                        <div class="card shadow-sm">
                                            <div class="card-body p-4">
                                                <form action="/scan" method="POST">
                                                    <div class="input-group input-group-lg">
                                                        <input type="text" name="indicator" class="form-control"
                                                            placeholder="Scan an IP, Domain, or Hash..." required
                                                            value="<%= scanResult ? scanResult.indicator : '' %>">
                                                        <button class="btn btn-primary px-4" type="submit"><i
                                                                class="bi bi-search me-2"></i>Scan</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="summary-stats mt-4">
                                    <p>
                                        <strong>Threat Feeds:</strong>
                                        <%= summaryStats.domain.toLocaleString() %> Domains | <%=
                                                summaryStats.ip.toLocaleString() %> IPs | <%=
                                                    summaryStats.hashes.toLocaleString() %> Hashes
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container result-container">
        <% if (scanResult) { %>
            <div class="card shadow-sm result-card" id="scanResult">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Scan Result</h5>
                    <span class="badge rounded-pill fs-6
                        <% if (scanResult.source === 'MISP Database') { %> bg-danger text-white
                        <% } else if (scanResult.source === 'Local Threat Feed') { %> bg-warning text-dark
                        <% } else { %> bg-success text-white <% } %>">
                        <i class="bi bi-database me-1"></i> Source: <%= scanResult.source %>
                    </span>
                </div>

                <% if (scanResult.source==='MISP Database' ) { %>
                    <div class="card-body">
                        <h4 class="mb-3 text-danger"><i class="bi bi-bug-fill me-2"></i>Threat Detected in MISP</h4>
                        <p class="text-muted">Found <strong>
                                <%= scanResult.data.length %>
                            </strong> related attribute(s) for <code><%= scanResult.indicator %></code></p>
                        <hr>
                        <% scanResult.data.forEach((attr, index)=> { %>
                            <div class="misp-attribute-card mb-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong><i class="bi bi-tag-fill text-primary me-2"></i>Category:</strong>
                                            <%= attr.category %>
                                        </p>
                                        <p><strong><i class="bi bi-box-seam text-primary me-2"></i>Type:</strong>
                                            <%= attr.type %>
                                        </p>
                                        <p><strong><i
                                                    class="bi bi-calendar-event text-primary me-2"></i>Timestamp:</strong>
                                            <%= new Date(attr.timestamp * 1000).toLocaleString() %>
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong><i class="bi bi-hash text-primary me-2"></i>Event ID:</strong> <span
                                                class="badge bg-secondary">
                                                <%= attr.event_id %>
                                            </span></p>
                                        <p><strong><i class="bi bi-info-circle-fill text-primary me-2"></i>Event
                                                Info:</strong>
                                            <%= attr.Event.info %>
                                        </p>
                                        <p><strong><i class="bi bi-building text-primary me-2"></i>Event Org:</strong>
                                            <%= attr.Event.Orgc.name %>
                                        </p>
                                    </div>
                                </div>
                                <% if(attr.comment) { %>
                                    <p class="mt-2"><strong><i
                                                class="bi bi-chat-left-text-fill text-primary me-2"></i>Comment:</strong>
                                        <%= attr.comment %>
                                    </p>
                                    <% } %>
                                        <% if(attr.Tag && attr.Tag.length> 0) { %>
                                            <div class="mt-2">
                                                <strong><i class="bi bi-tags-fill text-primary me-2"></i>Tags:</strong>
                                                <% attr.Tag.forEach(tag=> { %>
                                                    <span
                                                        class="badge rounded-pill bg-primary-subtle text-primary-emphasis">
                                                        <%= tag.name %>
                                                    </span>
                                                    <% }) %>
                                            </div>
                                            <% } %>
                            </div>
                            <% if (index < scanResult.data.length - 1) { %>
                                <hr>
                                <% } %>
                                    <% }) %>
                    </div>

                    <% } else if (scanResult.source==='Local Threat Feed' ) { %>
                        <div class="card-body">
                            <div class="alert alert-warning d-flex align-items-center">
                                <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                                <div>
                                    <h5 class="mb-0">Threat Detected in Local Feeds</h5>
                                    <span>This indicator is listed in our internal threat feeds.</span>
                                </div>
                            </div>
                            <ul class="list-group list-group-flush mt-3">
                                <li class="list-group-item"><strong>First Seen:</strong>
                                    <%= new Date(scanResult.data.firstSeen).toLocaleString() %>
                                </li>
                                <li class="list-group-item"><strong>Confidence:</strong>
                                    <%= scanResult.data.confidence %>%
                                </li>
                            </ul>
                        </div>

                        <% } else { %>
                            <div class="card-body text-center p-5">
                                <i class="bi bi-shield-check display-3 text-success"></i>
                                <h4 class="mt-3">No Threat Found</h4>
                                <p class="text-muted mb-0">The indicator <code><%= scanResult.indicator %></code> was
                                    not found in any of our databases.</p>
                            </div>
                            <% } %>
            </div>
            <script>
                document.addEventListener("DOMContentLoaded", () => {
                    document.getElementById('scanResult')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            </script>
            <% } %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>